<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ study.title }} - ìŠ¤í„°ë”” ë©”ì´íŠ¸</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .comment-like-btn {
            background: none; border: none; cursor: pointer;
            font-size: 13px; color: #888; display: flex; align-items: center; gap: 3px;
            margin-right: 8px; /* ë²„íŠ¼ ê°„ê²© */
        }
        .comment-like-btn:hover { color: #ff4757; }
        .liked { color: #ff4757 !important; font-weight: bold; }
    </style>
</head>

<body>

<header>
    <div class="nav-container">
        <a href="{{ url_for('index') }}" class="logo">STUDY MATE</a>

        <nav class="nav-menu">
            <a href="{{ url_for('index') }}">í™ˆ</a>
            <a href="{{ url_for('study') }}">ìŠ¤í„°ë”” ì°¾ê¸°</a>

            {% if user_nickname %}
            <div class="user-dropdown">
                <button class="user-btn" onclick="toggleDropdown()">
                    {{ user_nickname }} <span class="arrow">â–¾</span>
                </button>

                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="#">ë§ˆì´í˜ì´ì§€</a>
                    <a href="{{ url_for('my_posts') }}">ë‚´ê°€ ì“´ ê¸€</a>
                    <hr>
                    <a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>
            {% else %}
                <a href="{{ url_for('login') }}">ë¡œê·¸ì¸</a>
            {% endif %}
        </nav>
    </div>
</header>

<main>
    <section>
        <h2>{{ study.title }}</h2>

        <p style="color:#666; margin-bottom: 10px;">
            ğŸ‘‘ {{ study.writer }} Â· ğŸ‘¥ {{ study.member_count }}ëª… ëª¨ì§‘
        </p>

        <span class="tag">{{ study.category }}</span>

        <hr style="margin: 30px 0;">

        <p style="white-space: pre-line; font-size: 15px; line-height: 1.7;">
            {{ study.content }}
        </p>

        {% if user_nickname == study.writer %}
        <div class="action-buttons">
            <a href="{{ url_for('study_edit', study_id=study.id) }}" class="btn-edit">ìˆ˜ì •</a>
            <a href="{{ url_for('study_delete', study_id=study.id) }}" class="btn-delete" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
        </div>
        {% endif %}

        <hr style="margin: 40px 0; border: none; border-top: 1px solid #eee;">

        <div class="comment-section">
            <h3>ğŸ’¬ ëŒ“ê¸€ <span style="color:#007bff">{{ study.comments|length }}</span></h3>

            <div class="comment-list">
                {% for comment in study.comments %}
                    {% if not comment.parent_id %}
                    
                    <div class="comment-item">
                        <div class="comment-header">
                            <strong>{{ comment.writer }}</strong>
                            
                            {% if comment.writer == study.writer %}
                                <span class="writer-badge">ê¸€ì“´ì´</span>
                            {% endif %}

                            <span class="date">{{ comment.date.strftime('%m/%d %H:%M') }}</span>
                            
                            <div class="comment-actions" style="display:flex; align-items:center;">
                                <a href="{{ url_for('comment_like', comment_id=comment.id) }}" 
                                    class="comment-like-btn {% if current_user in comment.likers %}liked{% endif %}"
                                    style="text-decoration:none;">
                                    {% if current_user in comment.likers %}â™¥{% else %}â™¡{% endif %}
                                    {{ comment.likers|length }}
                                </a>

                                <button class="small-text-btn" onclick="toggleReplyForm('{{ comment.id }}')">ë‹µê¸€</button>
                                
                                {% if user_nickname == comment.writer %}
                                <a href="{{ url_for('comment_delete', comment_id=comment.id) }}" 
                                    class="delete-text-btn" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ë©´ ëŒ€ëŒ“ê¸€ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                                {% endif %}
                            </div>
                        </div>
                        <p class="comment-content">{{ comment.content }}</p>

                        {% for reply in comment.replies %}
                        <div class="reply-item">
                            <span class="reply-icon">â†³</span>
                            <div class="reply-body">
                                <div class="comment-header">
                                    <strong>{{ reply.writer }}</strong>
                                    
                                    {% if reply.writer == study.writer %}
                                        <span class="writer-badge">ê¸€ì“´ì´</span>
                                    {% endif %}
                                    
                                    <span class="date">{{ reply.date.strftime('%m/%d %H:%M') }}</span>
                                    
                                    <div class="comment-actions" style="display:flex; align-items:center;">
                                        <a href="{{ url_for('comment_like', comment_id=reply.id) }}" 
                                            class="comment-like-btn {% if current_user in reply.likers %}liked{% endif %}"
                                            style="text-decoration:none;">
                                            {% if current_user in reply.likers %}â™¥{% else %}â™¡{% endif %}
                                            {{ reply.likers|length }}
                                        </a>

                                        {% if user_nickname == reply.writer %}
                                        <a href="{{ url_for('comment_delete', comment_id=reply.id) }}" 
                                            class="delete-text-btn" onclick="return confirm('ì‚­ì œí• ê¹Œìš”?')">ì‚­ì œ</a>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="comment-content">{{ reply.content }}</p>
                            </div>
                        </div>
                        {% endfor %}

                        <div id="reply-form-{{ comment.id }}" class="reply-input-area" style="display:none;">
                            <form action="{{ url_for('comment_write', study_id=study.id) }}" method="POST" style="padding:10px; border:none;">
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <div style="display:flex; gap:10px;">
                                    <span style="padding-top:10px;">â†³</span>
                                    <input type="text" name="content" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                                    <button type="submit" class="primary-btn" style="width:80px; padding:10px;">ë“±ë¡</button>
                                </div>
                            </form>
                        </div>

                    </div>
                    <hr class="comment-divider">
                    {% endif %}
                {% endfor %}
            </div>

            <div class="main-comment-form">
                {% if user_nickname %}
                <form action="{{ url_for('comment_write', study_id=study.id) }}" method="POST" class="comment-form-box">
                    <input type="text" name="content" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”." required>
                    <button type="submit" class="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
                {% else %}
                <div style="text-align:center; padding:20px; background:#f9f9f9; border-radius:8px;">
                    <a href="{{ url_for('login') }}" style="color:#007bff; font-weight:bold;">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
        </div>
    </section>
</main>

<footer>
    <p>Â© 2026 Study Mate. Designed by ê¹€ë…¸í˜„</p>
</footer>

<script>
    function toggleDropdown() {
        const menu = document.getElementById('dropdownMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    document.addEventListener('click', function (e) {
        const dropdown = document.querySelector('.user-dropdown');
        const menu = document.getElementById('dropdownMenu');

        if (dropdown && !dropdown.contains(e.target)) {
            menu.style.display = 'none';
        }
    });

    function toggleReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>

</body>
</html>