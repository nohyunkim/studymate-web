<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€ - ìŠ¤í„°ë”” ë©”ì´íŠ¸</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<header>
    <div class="nav-container">
        <a href="{{ url_for('index') }}" class="logo">STUDY MATE</a>
        <nav class="nav-menu">
            <a href="{{ url_for('index') }}">í™ˆ</a>
            <a href="{{ url_for('study') }}">ìŠ¤í„°ë”” ì°¾ê¸°</a>
            <a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
        </nav>
    </div>
</header>

<main>
    <section class="profile-section">
        <div class="profile-icon">ğŸ‘¤</div>
        <h2>{{ user.nickname }}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</h2>
        <p class="text-muted">
            {{ user.email }}
        </p>


        <div id="bio-display">
            <div class="bio-text">
                {% if user.bio %}
                    "{{ user.bio }}"
                {% else %}
                    <span style="color:#aaa;">ì•„ì§ í•œì¤„ ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤. ì‘ì„±í•´ë³´ì„¸ìš”! ğŸ‘‡</span>
                {% endif %}
            </div>
            <button onclick="toggleBioEdit()" class="small-text-btn">âœï¸ í•œì¤„ ì†Œê°œ ìˆ˜ì •í•˜ê¸°</button>
        </div>

        <form id="bio-form" class="hidden"
            action="{{ url_for('update_profile') }}"
            method="POST">
            <div class="input-wrapper">
                <textarea name="bio" id="bio-input" class="bio-input" rows="2" maxlength="50"
                    placeholder="ë‚˜ë¥¼ í‘œí˜„í•˜ëŠ” í•œë§ˆë”” (50ì ì´ë‚´)">{{ user.bio if user.bio else '' }}</textarea>
            </div>
            
            <div style="margin-top: 8px;">
                <button type="submit" class="primary-btn" style="width: auto; padding: 6px 14px; font-size: 13px;">ì €ì¥</button>
                <button type="button" onclick="toggleBioEdit()" class="secondary-btn">ì·¨ì†Œ</button>
            </div>
        </form>
    </section>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="openTab('host')">ğŸ‘‘ ë‚´ê°€ ë§Œë“  ìŠ¤í„°ë””</button>
        <button class="tab-btn" onclick="openTab('guest')">ğŸš€ ë‚´ê°€ ì‹ ì²­í•œ ìŠ¤í„°ë””</button>
    </div>

    <div id="host" class="tab-content active">
        <div class="study-list">
            {% for study in my_studies %}
            <div class="card">
                <div>
                    <h3>{{ study.title }}</h3>
                    <span class="tag">{{ study.category }}</span>
                    <span class="tag">ğŸ‘¥ {{ study.member_count }}ëª… ëª¨ì§‘</span>
                    <hr class="divider-line">
                    
                    <h4 style="margin: 10px 0;">ğŸ“¬ ì‹ ì²­ì ê´€ë¦¬ ({{ study.enrollments|length }})</h4>
                </div>
                
                <div>
                    {% if study.enrollments|length == 0 %}
                        <p style="font-size:13px; color:#999;">ì•„ì§ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% else %}
                        {% for enroll in study.enrollments %}
                            <div class="applicant-item">
                                <div class="applicant-info">
                                    <a href="{{ url_for('profile', nickname=enroll.user.nickname) }}">
                                        {{ enroll.user.nickname }}
                                    </a>
                                    <div class="applicant-bio">
                                        {{ enroll.user.bio if enroll.user.bio else "ì•„ì§ ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤." }}
                                    </div>
                                </div>

                                <div class="applicant-actions">
                                    {% if enroll.status == 0 %}
                                        <a href="{{ url_for('enrollment_action', enrollment_id=enroll.id, action='accept') }}" 
                                            class="small-btn" style="background:#28a745; color:white; text-decoration:none; padding:5px 10px; border-radius:4px;">ìŠ¹ì¸</a>
                                        <a href="{{ url_for('enrollment_action', enrollment_id=enroll.id, action='reject') }}" 
                                            class="small-btn" style="background:#dc3545; color:white; text-decoration:none; padding:5px 10px; border-radius:4px;">ê±°ì ˆ</a>
                                    {% elif enroll.status == 1 %}
                                        <span class="status-badge status-1">ìŠ¹ì¸ë¨</span>
                                    {% else %}
                                        <span class="status-badge status-2">ê±°ì ˆë¨</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            {% if my_studies|length == 0 %}
                <p style="grid-column: 1 / -1; text-align:center; padding:30px; color:#888;">ì•„ì§ ëª¨ì§‘ ì¤‘ì¸ ìŠ¤í„°ë””ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

    <div id="guest" class="tab-content">
        <div class="study-list">
            {% for enroll in my_enrollments %}
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span class="tag">{{ enroll.study.category }}</span>
                    {% if enroll.status == 0 %}
                        <span class="status-badge status-0">â³ ëŒ€ê¸°ì¤‘</span>
                    {% elif enroll.status == 1 %}
                        <span class="status-badge status-1">ğŸ‰ ìŠ¹ì¸ë¨</span>
                    {% else %}
                        <span class="status-badge status-2">ğŸ˜­ ê±°ì ˆë¨</span>
                    {% endif %}
                </div>

                <h3>
                    <a href="{{ url_for('study_detail', study_id=enroll.study.id) }}">
                        {{ enroll.study.title }}
                    </a>
                </h3>
                <p style="font-size:13px; color:#666;">ë°©ì¥: {{ enroll.study.writer }}</p>

                {% if enroll.status == 1 and enroll.study.chat_link %}
                    <div style="margin-top:15px; background:#e8f3ff; padding:10px; border-radius:6px;">
                        <a href="{{ enroll.study.chat_link }}" target="_blank" style="font-weight:bold; color:#007bff; display:flex; align-items:center; gap:5px;">
                            ğŸ’¬ ì˜¤í”ˆì±„íŒ…ë°© ì…ì¥í•˜ê¸°
                        </a>
                    </div>
                {% endif %}
            </div>
            {% endfor %}

            {% if my_enrollments|length == 0 %}
                <p style="grid-column: 1 / -1; text-align:center; padding:30px; color:#888;">ì•„ì§ ì‹ ì²­í•œ ìŠ¤í„°ë””ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>
</main>

<script>
    // 1. íƒ­ ë©”ë‰´ ì „í™˜ í•¨ìˆ˜
    function openTab(tabName) {
        var contents = document.getElementsByClassName("tab-content");
        for (var i = 0; i < contents.length; i++) {
            contents[i].className = contents[i].className.replace(" active", "");
        }
        var btns = document.getElementsByClassName("tab-btn");
        for (var i = 0; i < btns.length; i++) {
            btns[i].className = btns[i].className.replace(" active", "");
        }
        document.getElementById(tabName).className += " active";
        event.currentTarget.className += " active";
    }

    // 2. í•œì¤„ ì†Œê°œ ìˆ˜ì •ì°½ í† ê¸€ í•¨ìˆ˜
    function toggleBioEdit() {
        const displayDiv = document.getElementById('bio-display');
        const formDiv = document.getElementById('bio-form');

        if (formDiv.style.display === 'none') {
            displayDiv.style.display = 'none';
            formDiv.style.display = 'block';
            const textarea = document.getElementById('bio-input');
            textarea.focus();
            const val = textarea.value; 
            textarea.value = ''; 
            textarea.value = val; 
        } else {
            displayDiv.style.display = 'block';
            formDiv.style.display = 'none';
        }
    }
</script>

</body>
</html>